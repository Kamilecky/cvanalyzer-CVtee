{% extends "base_app.html" %}

{% block title %}Analyzing CV... - CV Analyzer{% endblock %}

{% block content %}
<div class="text-center py-5">
    <div class="processing-spinner mb-4">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Analyzing...</span>
        </div>
    </div>
    <h2 id="processingTitle">Analyzing your CV...</h2>
    <p class="text-muted" id="processingSubtitle">Our AI is reviewing your CV for scoring, problems, and recommendations.</p>
    <p class="text-muted mt-3"><small>Optimized pipeline: typically 4-10 seconds.</small></p>

    <div class="progress mt-4 mx-auto" style="max-width: 400px; height: 24px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 5%">
            <span id="progressText">5%</span>
        </div>
    </div>
    <p class="text-muted mt-2" id="statusText">Initializing analysis...</p>

    <div id="stepsContainer" class="mt-4 text-start mx-auto" style="max-width: 400px;">
        <div class="step" id="step1"><i class="bi bi-circle text-muted me-2"></i> Cleaning & preparing text</div>
        <div class="step mt-1" id="step2"><i class="bi bi-circle text-muted me-2"></i> AI extracting data & detecting problems</div>
        <div class="step mt-1" id="step3"><i class="bi bi-circle text-muted me-2"></i> AI scoring & generating recommendations</div>
        <div class="step mt-1" id="step4"><i class="bi bi-circle text-muted me-2"></i> Saving results</div>
    </div>
</div>

<script>
(function() {
    var statusUrl = '{% url "analysis_status" analysis.id %}';
    var progressBar = document.getElementById('progressBar');
    var progressText = document.getElementById('progressText');
    var statusText = document.getElementById('statusText');

    var stepMessages = {
        5: 'Initializing analysis...',
        10: 'Cleaning CV text...',
        30: 'AI extracting data...',
        60: 'Data extracted! Starting scoring...',
        90: 'Saving results...',
        100: 'Analysis complete!'
    };

    function updateStep(progress) {
        var steps = ['step1', 'step2', 'step3', 'step4'];
        var thresholds = [30, 60, 90, 100];
        for (var i = 0; i < steps.length; i++) {
            var el = document.getElementById(steps[i]);
            var icon = el.querySelector('i');
            if (progress >= thresholds[i]) {
                icon.className = 'bi bi-check-circle-fill text-success me-2';
            } else if (progress > (i > 0 ? thresholds[i-1] : 0)) {
                icon.className = 'bi bi-arrow-right-circle-fill text-primary me-2';
            }
        }
    }

    function getStatusMessage(progress) {
        var msg = 'Processing...';
        var keys = Object.keys(stepMessages).map(Number).sort(function(a,b){return a-b;});
        for (var i = keys.length - 1; i >= 0; i--) {
            if (progress >= keys[i]) { msg = stepMessages[keys[i]]; break; }
        }
        return msg;
    }

    function poll() {
        fetch(statusUrl)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var progress = data.progress || 0;

                if (data.status === 'done' && data.redirect_url) {
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    statusText.textContent = 'Analysis complete! Redirecting...';
                    updateStep(100);
                    setTimeout(function() {
                        window.location.href = data.redirect_url;
                    }, 500);
                } else if (data.status === 'failed') {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    progressText.textContent = 'Error';
                    statusText.textContent = 'Analysis failed: ' + (data.error || 'Unknown error');
                    document.getElementById('processingTitle').textContent = 'Analysis Failed';
                } else {
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                    statusText.textContent = getStatusMessage(progress);
                    updateStep(progress);
                    setTimeout(poll, 2000);
                }
            })
            .catch(function() {
                setTimeout(poll, 3000);
            });
    }

    setTimeout(poll, 1000);
})();
</script>
{% endblock %}
