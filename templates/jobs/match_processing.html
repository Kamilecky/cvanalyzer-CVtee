{% extends "base_app.html" %}
{% load i18n %}

{% block title %}Matching... - CV Analyzer{% endblock %}

{% block content %}
<div class="text-center py-5">
    <div class="processing-spinner mb-4">
        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Matching...</span>
        </div>
    </div>
    <h2 id="processingTitle">Matching your CV with the job posting...</h2>
    <p class="text-muted">Our AI is comparing skills, keywords, and requirements.</p>

    <div class="progress mt-4 mx-auto" style="max-width: 400px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 10%"></div>
    </div>
    <p class="text-muted mt-2" id="statusText">Initializing...</p>
</div>

<script>
(function() {
    var statusUrl = '{% url "job_match_status" match.id %}';
    var progressBar = document.getElementById('progressBar');
    var statusText = document.getElementById('statusText');
    var progress = 10;

    function poll() {
        fetch(statusUrl)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'done' && data.redirect_url) {
                    progressBar.style.width = '100%';
                    statusText.textContent = 'Match complete! Redirecting...';
                    setTimeout(function() { window.location.href = data.redirect_url; }, 500);
                } else if (data.status === 'failed') {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                    statusText.textContent = 'Matching failed: ' + (data.error || 'Unknown error');
                } else {
                    if (progress < 90) {
                        progress += Math.random() * 15;
                        progressBar.style.width = Math.min(progress, 90) + '%';
                    }
                    statusText.textContent = 'Comparing CV with job requirements...';
                    setTimeout(poll, 2000);
                }
            })
            .catch(function() { setTimeout(poll, 3000); });
    }

    setTimeout(poll, 1500);
})();
</script>
{% endblock %}
